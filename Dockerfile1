FROM openjdk:11-jdk

# Install AWS CLI
RUN apt-get update && apt-get install -y \
    awscli \
    maven

# Set up the environment variable for AWS credentials
ENV AWS_ACCESS_KEY_ID=your-access-key-id
ENV AWS_SECRET_ACCESS_KEY=your-secret-access-key
ENV AWS_DEFAULT_REGION=us-west-2

# Set up any other environment variables needed for your application
# For example, environment variables for authentication token and domain
ENV CODEARTIFACT_DOMAIN=assyvajrala
ENV CODEARTIFACT_DOMAIN_OWNER=688567283917
ENV CODEARTIFACT_REPOSITORY=marvel# Get the authorization token during the build (or as part of your entrypoint)
RUN export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token --domain $CODEARTIFACT_DOMAIN --domain-owner $CODEARTIFACT_DOMAIN_OWNER --region $AWS_DEFAULT_REGION --query authorizationToken --output text)

# Configure Maven settings to include the CodeArtifact authentication token
RUN mkdir -p /root/.m2 && \
    echo "<servers>" > /root/.m2/settings.xml && \
    echo "  <server>" >> /root/.m2/settings.xml && \
    echo "    <id>assyvajrala-marvel</id>" >> /root/.m2/settings.xml && \
    echo "    <username>aws</username>" >> /root/.m2/settings.xml && \
    echo "    <password>${env.CODEARTIFACT_AUTH_TOKEN}</password>" >> /root/.m2/settings.xml && \
    echo "  </server>" >> /root/.m2/settings.xml && \
    echo "</servers>" >> /root/.m2/settings.xml && \
    echo "<profiles>" >> /root/.m2/settings.xml && \
    echo "  <profile>" >> /root/.m2/settings.xml && \
    echo "    <id>assyvajrala-marvel</id>" >> /root/.m2/settings.xml && \
    echo "    <activation>" >> /root/.m2/settings.xml && \
    echo "      <activeByDefault>true</activeByDefault>" >> /root/.m2/settings.xml && \
    echo "    </activation>" >> /root/.m2/settings.xml && \
    echo "    <repositories>" >> /root/.m2/settings.xml && \
    echo "      <repository>" >> /root/.m2/settings.xml && \
    echo "        <id>assyvajrala-marvel</id>" >> /root/.m2/settings.xml && \
    echo "        <url>https://assyvajrala-688567283917.d.codeartifact.us-west-2.amazonaws.com/maven/marvel/</url>" >> /root/.m2/settings.xml && \
    echo "      </repository>" >> /root/.m2/settings.xml && \
    echo "    </repositories>" >> /root/.m2/settings.xml && \
    echo "  </profile>" >> /root/.m2/settings.xml && \
    echo "</profiles>" >> /root/.m2/settings.xml

# Run Maven to build the project or fetch artifacts
RUN mvn clean install
WORKDIR /app
EXPOSE 8080
CMD ["mvn", "clean", "install"]

