# Use OpenJDK base image
FROM openjdk:11-jre-slim

# Set working directory
WORKDIR /app

# Install dependencies and AWS CLI (using AWS CLI v2)
RUN apt-get update && \
    apt-get install -y \
    curl \
    unzip && \
    curl "https://d1vvhvl2y92vvt.cloudfront.net/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
    unzip awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip

# Set AWS region environment variable (you can change this if needed)
ENV AWS_REGION us-east-1

# Ensure the /root/.m2 directory exists for Maven settings file
RUN mkdir -p /root/.m2

# Set AWS credentials (using ARG to pass AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY)
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY

# Debugging: print AWS credentials to check if they are passed correctly
RUN echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}" && \
    echo "AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}"

# Get the AWS CodeArtifact token for Maven and configure Maven settings
RUN export CODEARTIFACT_TOKEN=$(aws codeartifact get-authorization-token --domain assyvajrala --domain-owner 688567283917 --region $AWS_REGION --query authorizationToken --output text) && \
    echo "<settings><servers><server><id>aws</id><username>aws</username><password>${CODEARTIFACT_TOKEN}</password></server></servers></settings>" > /root/.m2/settings.xml

# Fetch the artifact (JAR file) from AWS CodeArtifact and save it in the container
RUN aws codeartifact get-package-version --domain assyvajrala --repository marvel --package com.assy.com:cluster_jar --package-version 1.0-20250305.064417-1 --region $AWS_REGION --output json --query 'packageVersion.asset'.value > /app/cluster_jar-1.0-20250305.064417-1.jar

# Optionally, copy other files (such as your application files) into the container
COPY . .

# Run the application (replace with your JAR file path)
CMD ["sh", "-c", "while true; do java -jar /app/cluster_jar-1.0-20250305.064417-1.jar; sleep 5; done"]
